<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passenger page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let passengerid = "30e7e4cf-d4d7-4bd6-bc6f-1a2ceb6aba5b";
        let updateCount = 0;
        var TripId = prompt("Enter TripId!");
        var connection = new signalR.HubConnectionBuilder()
          .withUrl("https://citybus.runasp.net/trackingHub")
          .build();

        var Notificationconnection = new signalR.HubConnectionBuilder()
          .withUrl("https://citybus.runasp.net/notificationHub")
          .build();

        function getCurrentPositionPromise() {
          return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
        }

        let StartStationlat = 0;
        let StartStationlon = 0;

        const url = `https://citybus.runasp.net/Booking/StartStation/${passengerid}`;
                  fetch(url, {
                    method: "GET",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  }).then((response) => response.json())
                    .then((result) => {
                      StartStationlat = result.latitude;
                      StartStationlon = result.longitude;
                    })

          connection
            .start()
            .then(() => {
              connection.on(
                "ReceiveLocationUpdate[" + TripId + "]",
                function (busId, lat, long) {
                  const url = `https://citybus.runasp.net/Route/CalcDistanceToDistnation/${StartStationlon}/${StartStationlat}/${long}/${lat}`;
                  fetch(url, {
                    method: "GET",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  })
                    .then((response) => response.json())
                    .then((result) => {
                      var Location =
                        "Bus [" +
                        busId +
                        "]: " +
                        "Latitude: " +
                        lat +
                        ", Longitude: " +
                        long;

                      var DistanceToLocation =
                        "Distance to you: " + result.distance + " km";
                      var DurationToLocation =
                        "Duration: " + result.duration + " minutes";

                      var locationDiv = document.getElementById("Location");
                      locationDiv.innerHTML +=
                        Location +
                        " [" +
                        DistanceToLocation +
                        ", " +
                        DurationToLocation +
                        "]<br>";
                    })
                    .catch((error) => {
                      console.error("Error fetching distance:", error);
                    });
                }
              );
            })
            .catch((err) => console.error(err.toString()));
        Notificationconnection.start().then(() => {
          Notificationconnection.on(
            "ReceiveNotification",
            function (notification) {
              alert(
                "Notification: " +
                  notification.msg +
                  "\nDate: " +
                  notification.date
              );
            }
          );
        });
      });
    </script>
  </head>
  <body>
    <p id="Location"></p>
  </body>
</html>
