<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passenger page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var TripId = prompt("Enter TripId!");
        var connection = new signalR.HubConnectionBuilder()
          .withUrl("https://citybus.runasp.net/trackingHub")
          .build();

          var Notificationconnection = new signalR.HubConnectionBuilder()
          .withUrl("https://citybus.runasp.net/notificationHub")
          .build();

        function getCurrentPositionPromise() {
          return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
        }

        getCurrentPositionPromise().then((position) => {
          const Userlat = Number(position.coords.latitude);
          const Userlon = Number(position.coords.longitude);

          connection
            .start()
            .then(() => {
              connection.on(
                "ReceiveLocationUpdate[" + TripId + "]",
                function (busId, lat, long) {
                  var Location =
                    "Bus" + "[" + busId +"]" +": " +
                    "Latitude: " + lat +
                    ", Longitude: " + long;

                  const url = `https://citybus.runasp.net/Route/CalcDistanceToDistnation/${Userlon}/${Userlat}/${lat}/${long}`;

                  fetch(url, {
                    method: "GET",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  })
                    .then((response) => response.json())
                    .then((result) => {
                      var DistanceToLocation =
                        "Distance to you: " + result.distance + " km";
                      var DurationToLocation =
                        "Duration: " + result.duration + " minutes";
                    });
                  var locationDiv = document.getElementById("Location");
                  locationDiv.innerHTML += Location + "[" + DistanceToLocation + ", " + DurationToLocation + "]<br>";
                }
              );
            })
            .catch((err) => console.error(err.toString()));
        });

        Notificationconnection
            .start()
            .then(() => {
              Notificationconnection.on(
                "ReceiveNotification",function (notification) {
                  alert("Notification: " + notification.msg + "\nDate: " + notification.date);
                })
            });
      });
    </script>
  </head>
  <body>
    <p id="Location"></p>
  </body>
</html>
